@using PrintingOrder.Controllers
@model PrintingOrder.Models.DailyReport

<div dir="rtl" class="container mt-4">
    <h2>تقرير الإنتاج اليومي - @Model.ReportDate?.ToString("yyyy/MM/dd")</h2>

    <form asp-action="SaveManagerNotes" asp-controller="Reports" method="post">
        <input type="hidden" name="reportId" value="@Model.Id" />

        <div class="form-group mb-3">
            <label>ملاحظات مدير الإنتاج:</label>
            <textarea class="form-control" name="notes" rows="3">@Model.ProductionManagerNotes</textarea>
        </div>

        <div class="mt-3 mb-3">
            <button type="button" class="btn btn-success" onclick="exportTableToExcel('reportTable', 'تقرير_الإنتاج_اليومي')">
                تصدير Excel
            </button>
            <button type="button" class="btn btn-secondary" onclick="window.print();">
                طباعة التقرير
            </button>
        </div>

        <table id="reportTable" class="table table-bordered table-sm">
            <thead class="table-dark">
                <tr>
                    <th>الآلة</th>
                    <th>مجموع ساعات العمل</th>
                    <th>النسخ المنجزة لكل أمر</th>
                    <th>الموظفون</th>
                    <th>الورديات</th>
                    <th>الحالة الفنية للآلة</th>
                    <th>ملاحظات الإنتاج</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    var producedDict = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, int>>(item.ProducedCopiesPerOrderJson ?? "{}");
                    var executors = System.Text.Json.JsonSerializer.Deserialize<List<ExecutorViewModel>>(item.ExecutorsWithShiftsJson ?? "[]");

                    <tr>
                        <td>@item.Machine?.Name</td>
                        <td>@item.TotalHours</td>
                        
                        <td>
                            <ul>
                                @foreach (var kv in producedDict)
                                {
                                    <li>@kv.Key: @kv.Value نسخة</li>
                                }
                            </ul>
                        </td>
                        <td>
                            <ul>
                                @foreach (var ex in executors)
                                {
                                    <li>@ex.Employee</li>
                                }
                            </ul>
                        </td>
                        <td>
                            <ul>
                                @foreach (var ex in executors)
                                {
                                    <li>@ex.Shifts</li>
                                }
                            </ul>
                        </td>
                        
                        <td>
                            <textarea class="form-control" name="machineStatuses[@item.Id]" rows="2">@item.MachineTechnicalStatus</textarea>
                        </td>
                        <td>@item.AggregatedProductionNotes</td>
                    </tr>
                }
            </tbody>
        </table>

        <button type="submit" class="btn btn-primary mt-3">حفظ التقرير</button>
    </form>
</div>

@section Scripts {
    <script>
        function exportTableToExcel(tableID, filename = ''){
            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

            filename = filename?filename+'.xls':'excel_data.xls';

            downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);

            if(navigator.msSaveOrOpenBlob){
                var blob = new Blob(['\ufeff', tableHTML], { type: dataType });
                navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                downloadLink.download = filename;
                downloadLink.click();
            }
        }
    </script>
}
