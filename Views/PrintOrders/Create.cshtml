@model PrintingOrder.Models.PrintOrder
@using PrintingOrder.Models
@{
    ViewData["Title"] = "إنشاء أمر تشغيل";
    var offset4Value = (int)MachineType.Offset4Color;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-body p-5">
                    <h2 class="fw-bold text-center text-primary mb-4">
                        إضافة أمر طباعة كتاب مدرسي
                    </h2>
                    <hr />

                    <form asp-action="Create">
                        <div asp-validation-summary="All" class="text-danger  mb-3"></div>

                        @* <div class="mb-3">
                            <label asp-for="MachineType" class="form-label"></label>
                            <select asp-for="MachineType" class="form-select" id="MachineType"
                                    asp-items="Html.GetEnumSelectList<MachineType>()"></select>
                            <span asp-validation-for="MachineType" class="text-danger"></span>
                        </div> *@

                        <div class="mb-3">
                            <label asp-for="PrintName" class="form-label"></label>
                            <input asp-for="PrintName" class="form-control" />
                            <span asp-validation-for="PrintName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Date" class="form-label"></label>
                            <input asp-for="Date" type="date" class="form-control" />
                            <span asp-validation-for="Date" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ContractNumber" class="form-label"></label>
                                <input asp-for="ContractNumber" class="form-control" />
                                <span asp-validation-for="ContractNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrderNumber" class="form-label"></label>
                                <input asp-for="OrderNumber" class="form-control" />
                                <span asp-validation-for="OrderNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CopiesCount" class="form-label"></label>
                                <input asp-for="CopiesCount" class="form-control" id="CopiesCount" />
                                <span asp-validation-for="CopiesCount" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="PagesCount" class="form-label"></label>
                                <input asp-for="PagesCount" class="form-control" id="PagesCount" />
                                <span asp-validation-for="PagesCount" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">عدد الملازم الكلي</label>
                                <input asp-for="TotalPrintSignatureCount" class="form-control" id="TotalBooklets" readonly />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">عدد الكبسات الإجمالي</label>
                                <input asp-for="TotalPressRuns" class="form-control" id="TotalPressRuns" readonly />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Size" class="form-label"></label>
                            <select asp-for="Size" class="form-select">
                                <option value="20.5x24">20.5 × 24</option>
                                <option value="17.5x24">17.5 × 24</option>
                            </select>
                            <span asp-validation-for="Size" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label"></label>
                            <textarea asp-for="Notes" class="form-control" rows="2"></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Details" class="form-label"></label>
                            <textarea asp-for="Details" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Details" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                عرض جميع أوامر التشغيل
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                إضافة
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const OFFSET4 = @offset4Value;

            const copiesEl = document.getElementById('CopiesCount');
            const pagesEl = document.getElementById('PagesCount');
            const machineEl = document.getElementById('MachineType');
            const totalBookletsEl = document.getElementById('TotalBooklets');
            const totalPressRunsEl = document.getElementById('TotalPressRuns');

            function isOffsetFour() {
                const val = machineEl.value;
                const parsed = parseInt(val);
                if (!isNaN(parsed)) return parsed === OFFSET4;
                if (val === 'Offset4Color') return true;
                const txt = machineEl.selectedOptions?.[0]?.text || '';
                return txt.includes('4 لون') || txt.toLowerCase().includes('4');
            }

            function calculate() {
                const copies = parseInt(copiesEl?.value) || 0;
                const pages = parseInt(pagesEl?.value) || 0;

                const perCopyBooklets = pages > 0 ? Math.ceil(pages / 16) : 0;
                const totalBooklets = perCopyBooklets * copies;

                let totalPressRuns = totalBooklets;
                if (isOffsetFour()) {
                    totalPressRuns = Math.ceil(totalBooklets / 2);
                }

                totalBookletsEl.value = totalBooklets;
                totalPressRunsEl.value = totalPressRuns;
            }

            [copiesEl, pagesEl, machineEl].forEach(el => el?.addEventListener('input', calculate));
            calculate();
        });
    </script>
}
